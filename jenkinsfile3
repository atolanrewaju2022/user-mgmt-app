currentBuild.displayName = "nodejs-app-#" + currentBuild.number 

pipeline {
  agent any {
  
  stages {

      stage('Git Clone') {
         steps {
            script {
               git branch: master,
               credentialsId: <your credentials id>,
               url: "https://github.com/lanru2001/Nodejs-React-App.git"
            }
         }
      }
    
      stage('Docker Build') {
         steps {
            script {
                docker.build('node-app')
            }
         }
      }
    
      stage('Push to ECR') {
            steps {
                script {
                    sh "aws ecr get-login-password --region us-east-2 | docker login --username AWS --password-stdin 873079457075.dkr.ecr.us-east-2.amazonaws.com"
                    
                    sh "docker tag node-app:latest 873079457075.dkr.ecr.us-east-2.amazonaws.com/node-app:latest"

                    
                    sh "docker push 873079457075.dkr.ecr.us-east-2.amazonaws.com/node-app:latest"

                } 
            }
      }    
    
    
      stage('Update To Task Definition') {
         steps {
             script {
                 withAWS(region: 'ap-southeast-1', credentials: 'awsId') {
                    taskDefRegistry = readJSON text: sh(returnStdout: true, script:"aws ecs register-task-definition \
                        --memory 4096 \
                        --cpu 2048 \
                        --task-role-arn <task-role-arn> \
                        --family <task-def-name> \
                        --network-mode awsvpc \
                        --requires-compatibilities EC2 FARGATE \
                        --cli-input-json file://taskdef.json"), returnPojo: true
                 }
             }
         }
      }  
 
      stage('Update To ECS') {
          steps {
             script { 
                try {
                   withAWS(region: 'us-east-2', credentials: 'awsId') {
                      def updateService = "aws ecs update-service --service <your-ecs-service-name> --cluster <your-cluster-name> --force-new-deployment"
                      def runUpdateService = sh(returnStdout: true, script: updateService)
                      def serviceStable = "aws ecs wait services-stable --service $internationalService --cluster $internationalCluster"
                      sh(returnStdout: true, script: serviceStable)
                      # put all your slack messaging here
                   }
                }  
                catch(Exception e) {
                    echo e.message.toString()
                }
             }
          } 
      }    
          
 }

}
 
